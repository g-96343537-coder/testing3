<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>二年级数学测验成绩统计</title>
<style>
/* 样式同前面教师端 HTML */
</style>
</head>
<body>
<h1>二年级数学测验成绩统计</h1>
<div id="stats">
  <h2>班级统计</h2>
  <div id="classStats"></div>
</div>
<input id="filter" placeholder="按班级或学生姓名搜索...">
<table id="scoreTable">
  <thead>
    <tr><th>姓名</th><th>班级</th><th>得分</th><th>总题数</th><th>提交时间</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxYNeL4SjR7Phcn-3YdiWf3b-n_C2iZiBhxoi-MGw8a/exec";

async function fetchScores() {
  try {
    const res = await fetch(GAS_URL);
    const data = await res.json();
    renderTable(data);
    renderClassStats(data);
  } catch(err) {
    console.error("读取成绩失败:", err);
    alert("无法获取成绩，请检查网络或 GAS 部署。");
  }
}

function renderTable(data) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";
  data.sort((a,b)=>b.score-a.score);
  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.name}</td><td>${row.class}</td><td>${row.score}</td><td>${row.total}</td><td>${row.timestamp}</td>`;
    tbody.appendChild(tr);
  });
}

function renderClassStats(data){
  const statsDiv = document.getElementById("classStats");
  const classMap = {};
  data.forEach(r=>{
    if(!classMap[r.class]) classMap[r.class]=[];
    classMap[r.class].push(r.score);
  });
  let html = "<table style='margin:auto; width:60%; text-align:center;'>";
  html += "<tr><th>班级</th><th>学生数</th><th>平均分</th><th>最高分</th><th>最低分</th></tr>";
  for(const cls in classMap){
    const scores = classMap[cls];
    const avg = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1);
    const max = Math.max(...scores);
    const min = Math.min(...scores);
    html += `<tr><td>${cls}</td><td>${scores.length}</td><td>${avg}</td><td>${max}</td><td>${min}</td></tr>`;
  }
  html += "</table>";
  statsDiv.innerHTML = html;
}

document.getElementById("filter").addEventListener("input", e=>{
  const filter = e.target.value.toLowerCase();
  document.querySelectorAll("#scoreTable tbody tr").forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(filter) ? "" : "none";
  });
});

fetchScores();
</script>
</body>
</html>
